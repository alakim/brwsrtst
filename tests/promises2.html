<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<link rel="stylesheet" href="../lib/test.css"/>
<script src="../lib/jquery-3.1.1.min.js"></script>
<script src="../lib/html.js"></script>
<script>
'use strict';
$(function(){
	var errors = [];
	////////////////////////////////////////////////////////////////////
	
	
	//************************ Пример использования промисов в расчетах ********************************
	// промисы позволяют производить отложенные вычисления с данными, которые будут получены позже
	
	// Модель веб-сервиса банка
	let bank = {
		// Возвращает баланс банковского счета (в рублях) для заданного пользователя
		getAccountBalanceRuR(name, password){
			return new Promise((resolve, reject)=>{
				setTimeout(()=>{
					if(name=='user1' && password=='1234')
						resolve(50000);
					else
						reject('Bad user name or password');
				}, 800);
			});
		},
		// Возвращает курс доллара к рублю
		getUsd2RuR(){
			return new Promise((resolve)=>{
				setTimeout(()=>{
					resolve(62);
				}, 500);
			});
		}
	};
	
	// Модель веб-сервиса интернет-магазина
	let shop = {
		// Возвращает прайс-лист
		getPricelist(){
			return new Promise((resolve, reject)=>{
				setTimeout(()=>{
					resolve({
						clarinets:[
							{name:'Selmer CL301', priceRuR:30000, weight:1.3},
							{name:'Buffet Prestige', priceRuR:250000, weight:1.5}
						]
					});
				}, 790);
			});
		}
	};
	
	// Модель веб-сервиса службы доставки
	let post = {
		// Возвращает цену доставки в рублях для заданного веса
		getPostPriceRuR(weight){
			return new Promise((resolve, reject)=>{
				setTimeout(()=>{
					resolve(weight*320);
				},300);
			});
		}
	};
	
	
	// Рассчитываем цену покупки кларнета в долларах с доставкой 
	// Часть данных получаем в виде промисов
	
	let usd2Rur = bank.getUsd2RuR();										// заранее узнаем курс валюты - запоминаем его в виде промиса
	let myBalance = bank.getAccountBalanceRuR('user1', '1234')				// заранее узнаем баланс счета - тоже в виде промиса
	
	shop.getPricelist().then(												// получаем прайс-лист
		priceList=>priceList.clarinets.find(cl=>cl.name=='Selmer CL301')	// выбираем товар
	)
	// асинхронные вычисления в виде цепочки промисов
	.then(clarinet=>Promise.all([											// исходные данные - простые значения и промисы - ВСЕ В КУЧУ!
		clarinet.priceRuR,													// цена кларнета - это уже известное значение
		post.getPostPriceRuR(clarinet.weight),								// цена доставки - получаем от сервиса в виде промиса
		usd2Rur,															// курс валюты - промис, полученный заранее
		myBalance															// баланс банковского счета - тоже полученный заранее промис
	]))
	.then(([price, postPrice, usd2Rur, myBalance])=>{						// когда все промисы благополучно разрешились
		console.log(`price: ${price} руб, post price: ${postPrice} руб, USD/RUR: ${usd2Rur}, my balance: ${myBalance} руб`);
		var sumRuR = price + postPrice;
		if(sumRuR>myBalance) alert('No money - no clarinet!');
		var sumUsd = (sumRuR/usd2Rur).toFixed(2);
		console.log(`Total price: $${sumUsd}, balance left: ${myBalance-sumRuR} руб`);
		if(sumUsd!=490.58){
			errors.push('Error 1');
		}
		
		showErrors();
	});
	
	
	////////////////////////////////////////////////////////////////////
	
	function showErrors(){
		if(errors.length){
			$('body').addClass('error');
			$('body').append(Html.div(
				Html.apply(errors, function(msg){
					return Html.p(msg);
				})
			));
		}
		else
			$('body').addClass('success');
	}
});
</script>
</head>
<body>
	<p>Promises - lazy evaluation sample</p>
</body>
</html>

